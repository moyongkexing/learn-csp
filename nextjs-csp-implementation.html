<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Next.jsã§CSP Level 3ã‚’å®Ÿè£…ã™ã‚‹ - ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‹ã‚‰nonceã®å®Ÿè£…ã¾ã§</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f5f5;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        article {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #000;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-align: center;
            background: linear-gradient(135deg, #000 0%, #333 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        h2 {
            color: #000;
            margin: 40px 0 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }
        
        h3 {
            color: #333;
            margin: 30px 0 15px;
        }
        
        h4 {
            color: #555;
            margin: 20px 0 10px;
        }
        
        p {
            margin-bottom: 15px;
        }
        
        code {
            background: #f4f4f4;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
            border-radius: 5px;
            overflow-x: auto;
            margin: 20px 0;
            position: relative;
        }
        
        pre code {
            background: none;
            padding: 0;
            color: #d4d4d4;
        }
        
        .comment {
            color: #6A9955;
        }
        
        .keyword {
            color: #569CD6;
        }
        
        .string {
            color: #CE9178;
        }
        
        .function {
            color: #DCDCAA;
        }
        
        .number {
            color: #B5CEA8;
        }
        
        ul, ol {
            margin: 15px 0 15px 30px;
        }
        
        li {
            margin-bottom: 8px;
        }
        
        .info-box {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .success-box {
            background: #d4edda;
            border-left: 4px solid #28a745;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .danger-box {
            background: #f8d7da;
            border-left: 4px solid #dc3545;
            padding: 20px;
            border-radius: 5px;
            margin: 20px 0;
        }
        
        .file-name {
            background: #333;
            color: #fff;
            padding: 5px 15px;
            border-radius: 5px 5px 0 0;
            display: inline-block;
            margin-bottom: -1px;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
        }
        
        .demo-container {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 30px;
            margin: 30px 0;
        }
        
        .demo-title {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            color: #495057;
        }
        
        .flow-diagram {
            display: flex;
            align-items: center;
            justify-content: space-around;
            margin: 30px 0;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .flow-item {
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            flex: 1;
            min-width: 200px;
            position: relative;
        }
        
        .flow-item::after {
            content: "â†’";
            position: absolute;
            right: -30px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 24px;
            color: #6c757d;
        }
        
        .flow-item:last-child::after {
            display: none;
        }
        
        .flow-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }
        
        .interactive-demo {
            background: #000;
            color: #fff;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
        }
        
        .console-line {
            margin: 5px 0;
        }
        
        .console-success {
            color: #4EC9B0;
        }
        
        .console-error {
            color: #F48771;
        }
        
        .console-info {
            color: #3794FF;
        }
        
        button {
            background: #000;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px 5px;
        }
        
        button:hover {
            background: #333;
            transform: translateY(-1px);
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #dee2e6;
        }
        
        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 5px 5px 0 0;
            background: #f8f9fa;
            transition: all 0.3s;
        }
        
        .tab.active {
            background: #000;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .highlight {
            background: #ffd54f;
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: bold;
            color: #333;
        }
        
        .nextjs-logo {
            display: inline-block;
            vertical-align: middle;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <article>
            <h1>
                <span class="nextjs-logo">â–²</span>
                Next.jsã§CSP Level 3ã‚’å®Ÿè£…ã™ã‚‹
            </h1>
            
            <div class="info-box">
                <strong>ã“ã®è¨˜äº‹ã§å­¦ã¹ã‚‹ã“ã¨ï¼š</strong>
                <ul>
                    <li>Next.jsã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã¯ä½•ã‹</li>
                    <li>ãªãœãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§CSPã‚’è¨­å®šã™ã‚‹ã®ã‹</li>
                    <li>nonceã®ç”Ÿæˆã¨ç®¡ç†æ–¹æ³•</li>
                    <li>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã¸ã®nonceä¼é”æ–¹æ³•</li>
                    <li>å®Ÿè·µçš„ãªå®Ÿè£…ä¾‹ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</li>
                </ul>
            </div>

            <h2>ğŸ¤” Next.jsã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¨ã¯ï¼Ÿ</h2>
            
            <h3>ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®åŸºæœ¬æ¦‚å¿µ</h3>
            <p>Next.jsã®ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯ã€<strong>ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒå®Œäº†ã™ã‚‹å‰ã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚³ãƒ¼ãƒ‰</strong>ã§ã™ã€‚ã‚µãƒ¼ãƒãƒ¼ã¨ãƒšãƒ¼ã‚¸ã®é–“ã«ä½ç½®ã—ã€ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’åŠ å·¥ã§ãã¾ã™ã€‚</p>
            
            <div class="flow-diagram">
                <div class="flow-item">
                    <div class="flow-icon">ğŸŒ</div>
                    <strong>ãƒ–ãƒ©ã‚¦ã‚¶</strong><br>
                    ãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡
                </div>
                <div class="flow-item" style="background: #e3f2fd;">
                    <div class="flow-icon">âš™ï¸</div>
                    <strong>ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢</strong><br>
                    ãƒªã‚¯ã‚¨ã‚¹ãƒˆ/ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†
                </div>
                <div class="flow-item">
                    <div class="flow-icon">ğŸ“„</div>
                    <strong>ãƒšãƒ¼ã‚¸/API</strong><br>
                    å®Ÿéš›ã®å‡¦ç†
                </div>
            </div>

            <h3>ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã§ãã‚‹ã“ã¨</h3>
            <ul>
                <li>âœ… ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®èª­ã¿å–ã‚Šãƒ»å¤‰æ›´</li>
                <li>âœ… ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã®è¨­å®šï¼ˆCSPãªã©ï¼‰</li>
                <li>âœ… ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚„ãƒªãƒ©ã‚¤ãƒˆ</li>
                <li>âœ… èªè¨¼ãƒ»èªå¯ã®ãƒã‚§ãƒƒã‚¯</li>
                <li>âœ… ãƒ­ã‚®ãƒ³ã‚°ã‚„åˆ†æ</li>
            </ul>

            <div class="warning-box">
                <strong>âš ï¸ é‡è¦ãªåˆ¶é™ï¼š</strong>
                <p>ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã¯<strong>Edge Runtime</strong>ã§å®Ÿè¡Œã•ã‚Œã‚‹ãŸã‚ã€Node.js APIã®ä¸€éƒ¨ï¼ˆfsã€pathãªã©ï¼‰ã¯ä½¿ç”¨ã§ãã¾ã›ã‚“ã€‚</p>
            </div>

            <h3>åŸºæœ¬çš„ãªãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã®ä¾‹</h3>
            
            <div class="file-name">middleware.ts</div>
            <pre><code><span class="keyword">import</span> { NextResponse } <span class="keyword">from</span> <span class="string">'next/server'</span>
<span class="keyword">import type</span> { NextRequest } <span class="keyword">from</span> <span class="string">'next/server'</span>

<span class="keyword">export function</span> <span class="function">middleware</span>(request: NextRequest) {
  <span class="comment">// ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®URLã‚’å–å¾—</span>
  console.log(<span class="string">'ãƒªã‚¯ã‚¨ã‚¹ãƒˆURL:'</span>, request.url)
  
  <span class="comment">// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½œæˆ</span>
  <span class="keyword">const</span> response = NextResponse.next()
  
  <span class="comment">// ã‚«ã‚¹ã‚¿ãƒ ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’è¿½åŠ </span>
  response.headers.set(<span class="string">'X-Custom-Header'</span>, <span class="string">'Hello from Middleware!'</span>)
  
  <span class="keyword">return</span> response
}

<span class="comment">// ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’é©ç”¨ã™ã‚‹ãƒ‘ã‚¹ã‚’æŒ‡å®š</span>
<span class="keyword">export const</span> config = {
  matcher: <span class="string">'/((?!api|_next/static|_next/image|favicon.ico).*)'</span>,
}</code></pre>

            <h2>ğŸ›¡ï¸ ãªãœãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§CSPã‚’è¨­å®šã™ã‚‹ã®ã‹ï¼Ÿ</h2>
            
            <h3>CSPå®Ÿè£…ã®3ã¤ã®æ–¹æ³•</h3>
            
            <div class="demo-container">
                <div class="tabs">
                    <div class="tab active" onclick="showTab('method1')">âŒ æ–¹æ³•1: ãƒ¡ã‚¿ã‚¿ã‚°</div>
                    <div class="tab" onclick="showTab('method2')">âš ï¸ æ–¹æ³•2: next.config.js</div>
                    <div class="tab" onclick="showTab('method3')">âœ… æ–¹æ³•3: ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢</div>
                </div>
                
                <div id="method1" class="tab-content active">
                    <h4>âŒ ãƒ¡ã‚¿ã‚¿ã‚°ã§ã®è¨­å®šï¼ˆéæ¨å¥¨ï¼‰</h4>
                    <pre><code>&lt;meta 
  http-equiv=<span class="string">"Content-Security-Policy"</span> 
  content=<span class="string">"script-src 'nonce-abc123' 'strict-dynamic';"</span>
/&gt;</code></pre>
                    <div class="danger-box">
                        <strong>å•é¡Œç‚¹ï¼š</strong>
                        <ul>
                            <li>HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã‚ˆã‚Šå„ªå…ˆåº¦ãŒä½ã„</li>
                            <li>ä¸€éƒ¨ã®CSPãƒ‡ã‚£ãƒ¬ã‚¯ãƒ†ã‚£ãƒ–ãŒå‹•ä½œã—ãªã„</li>
                            <li>å‹•çš„ãªnonceç”ŸæˆãŒå›°é›£</li>
                        </ul>
                    </div>
                </div>
                
                <div id="method2" class="tab-content">
                    <h4>âš ï¸ next.config.jsã§ã®è¨­å®šï¼ˆåˆ¶é™ã‚ã‚Šï¼‰</h4>
                    <pre><code><span class="keyword">module</span>.exports = {
  <span class="keyword">async</span> <span class="function">headers</span>() {
    <span class="keyword">return</span> [{
      source: <span class="string">'/(.*)'</span>,
      headers: [{
        key: <span class="string">'Content-Security-Policy'</span>,
        value: <span class="string">"script-src 'self' 'strict-dynamic';"</span> <span class="comment">// é™çš„ãªå€¤ã®ã¿</span>
      }],
    }]
  },
}</code></pre>
                    <div class="warning-box">
                        <strong>å•é¡Œç‚¹ï¼š</strong>
                        <ul>
                            <li>nonceã‚’å‹•çš„ã«ç”Ÿæˆã§ããªã„ï¼ˆæ¯å›åŒã˜å€¤ï¼‰</li>
                            <li>ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã®å‡¦ç†ãŒã§ããªã„</li>
                        </ul>
                    </div>
                </div>
                
                <div id="method3" class="tab-content">
                    <h4>âœ… ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã§ã®è¨­å®šï¼ˆæ¨å¥¨ï¼‰</h4>
                    <pre><code><span class="keyword">export function</span> <span class="function">middleware</span>(request: NextRequest) {
  <span class="keyword">const</span> nonce = <span class="function">generateNonce</span>() <span class="comment">// ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«æ–°ã—ã„nonce</span>
  
  <span class="keyword">const</span> cspHeader = <span class="string">`
    script-src 'nonce-</span><span class="string">${nonce}</span><span class="string">' 'strict-dynamic';
    object-src 'none';
    base-uri 'none';
  `</span>.replace(<span class="string">/\s{2,}/g</span>, <span class="string">' '</span>).trim()
  
  <span class="keyword">const</span> response = NextResponse.next()
  response.headers.set(<span class="string">'Content-Security-Policy'</span>, cspHeader)
  
  <span class="keyword">return</span> response
}</code></pre>
                    <div class="success-box">
                        <strong>åˆ©ç‚¹ï¼š</strong>
                        <ul>
                            <li>ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«æ–°ã—ã„nonceã‚’ç”Ÿæˆ</li>
                            <li>å‹•çš„ãªå‡¦ç†ãŒå¯èƒ½</li>
                            <li>ã™ã¹ã¦ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«é©ç”¨</li>
                        </ul>
                    </div>
                </div>
            </div>

            <h2>ğŸ² nonceã®å®Ÿè£…</h2>
            
            <h3>Step 1: nonceã®ç”Ÿæˆ</h3>
            
            <div class="file-name">middleware.ts</div>
            <pre><code><span class="keyword">import</span> { NextResponse } <span class="keyword">from</span> <span class="string">'next/server'</span>
<span class="keyword">import type</span> { NextRequest } <span class="keyword">from</span> <span class="string">'next/server'</span>

<span class="comment">// cryptoã¯Edge Runtimeã§ã‚‚åˆ©ç”¨å¯èƒ½</span>
<span class="keyword">function</span> <span class="function">generateNonce</span>(): <span class="keyword">string</span> {
  <span class="keyword">const</span> array = <span class="keyword">new</span> Uint8Array(<span class="number">16</span>)
  crypto.getRandomValues(array)
  <span class="keyword">return</span> Buffer.from(array).toString(<span class="string">'base64'</span>)
}

<span class="keyword">export function</span> <span class="function">middleware</span>(request: NextRequest) {
  <span class="keyword">const</span> nonce = <span class="function">generateNonce</span>()
  
  <span class="comment">// CSPãƒ˜ãƒƒãƒ€ãƒ¼ã‚’æ§‹ç¯‰</span>
  <span class="keyword">const</span> cspHeader = <span class="string">`
    default-src 'self';
    script-src 'nonce-</span><span class="string">${nonce}</span><span class="string">' 'strict-dynamic';
    style-src 'self' 'nonce-</span><span class="string">${nonce}</span><span class="string">';
    img-src 'self' blob: data:;
    font-src 'self';
    object-src 'none';
    base-uri 'self';
    form-action 'self';
    frame-ancestors 'none';
    upgrade-insecure-requests;
  `</span>.replace(<span class="string">/\s{2,}/g</span>, <span class="string">' '</span>).trim()
  
  <span class="keyword">const</span> response = NextResponse.next()
  
  <span class="comment">// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«CSPã‚’è¨­å®š</span>
  response.headers.set(<span class="string">'Content-Security-Policy'</span>, cspHeader)
  
  <span class="comment">// nonceã‚’ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã«å«ã‚ã‚‹ï¼ˆå¾Œã§å–å¾—ã™ã‚‹ãŸã‚ï¼‰</span>
  response.headers.set(<span class="string">'x-nonce'</span>, nonce)
  
  <span class="keyword">return</span> response
}</code></pre>

            <div class="info-box">
                <strong>ğŸ’¡ ãªãœBuffer.from().toString('base64')ã‚’ä½¿ã†ã®ã‹ï¼Ÿ</strong>
                <p>base64ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰ã«ã‚ˆã‚Šã€ãƒ©ãƒ³ãƒ€ãƒ ãªãƒã‚¤ãƒˆåˆ—ã‚’å®‰å…¨ã«HTTPãƒ˜ãƒƒãƒ€ãƒ¼ã‚„HTMLå±æ€§ã§ä½¿ãˆã‚‹æ–‡å­—åˆ—ã«å¤‰æ›ã—ã¾ã™ã€‚</p>
            </div>

            <h3>Step 2: Server Componentã§nonceã‚’å–å¾—</h3>
            
            <div class="file-name">app/layout.tsx</div>
            <pre><code><span class="keyword">import</span> { headers } <span class="keyword">from</span> <span class="string">'next/headers'</span>
<span class="keyword">import</span> Script <span class="keyword">from</span> <span class="string">'next/script'</span>

<span class="keyword">export default function</span> <span class="function">RootLayout</span>({
  children,
}: {
  children: React.ReactNode
}) {
  <span class="comment">// Server Componentã§ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰nonceã‚’å–å¾—</span>
  <span class="keyword">const</span> nonce = headers().get(<span class="string">'x-nonce'</span>) || <span class="string">''</span>
  
  <span class="keyword">return</span> (
    &lt;html lang=<span class="string">"ja"</span>&gt;
      &lt;head&gt;
        <span class="comment">{/* nonceã‚’ä½¿ã£ãŸã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */}</span>
        &lt;style nonce={nonce}&gt;
          {<span class="string">`
            body {
              margin: 0;
              font-family: system-ui, sans-serif;
            }
          `</span>}
        &lt;/style&gt;
      &lt;/head&gt;
      &lt;body&gt;
        {children}
        
        <span class="comment">{/* Next.jsã®Scriptã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«nonceã‚’æ¸¡ã™ */}</span>
        &lt;Script
          src=<span class="string">"/analytics.js"</span>
          strategy=<span class="string">"afterInteractive"</span>
          nonce={nonce}
        /&gt;
        
        <span class="comment">{/* ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®ä¾‹ */}</span>
        &lt;script nonce={nonce}&gt;
          {<span class="string">`
            console.log('This inline script has nonce!');
          `</span>}
        &lt;/script&gt;
      &lt;/body&gt;
    &lt;/html&gt;
  )
}</code></pre>

            <h3>Step 3: Client Componentã¸ã®nonceä¼é”</h3>
            
            <div class="warning-box">
                <strong>âš ï¸ é‡è¦ï¼š</strong>
                <p>Client Componentã§ã¯<code>headers()</code>ã‚’ç›´æ¥ä½¿ãˆã¾ã›ã‚“ã€‚Server Componentã‹ã‚‰Propsã¨ã—ã¦æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚</p>
            </div>
            
            <div class="file-name">app/components/ClientAnalytics.tsx</div>
            <pre><code><span class="string">'use client'</span>

<span class="keyword">import</span> { useEffect } <span class="keyword">from</span> <span class="string">'react'</span>
<span class="keyword">import</span> Script <span class="keyword">from</span> <span class="string">'next/script'</span>

<span class="keyword">interface</span> ClientAnalyticsProps {
  nonce: <span class="keyword">string</span>
}

<span class="keyword">export default function</span> <span class="function">ClientAnalytics</span>({ nonce }: ClientAnalyticsProps) {
  useEffect(() => {
    <span class="comment">// Client Componentã§ã®å‹•çš„ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ</span>
    <span class="keyword">const</span> script = document.createElement(<span class="string">'script'</span>)
    script.nonce = nonce
    script.textContent = <span class="string">`
      console.log('Dynamically created script with nonce!');
    `</span>
    document.body.appendChild(script)
  }, [nonce])
  
  <span class="keyword">return</span> (
    &lt;&gt;
      <span class="comment">{/* Next.jsã®Scriptã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ */}</span>
      &lt;Script
        id=<span class="string">"google-analytics"</span>
        strategy=<span class="string">"afterInteractive"</span>
        nonce={nonce}
      &gt;
        {<span class="string">`
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'GA_MEASUREMENT_ID');
        `</span>}
      &lt;/Script&gt;
    &lt;/&gt;
  )
}</code></pre>

            <div class="file-name">app/page.tsx</div>
            <pre><code><span class="keyword">import</span> { headers } <span class="keyword">from</span> <span class="string">'next/headers'</span>
<span class="keyword">import</span> ClientAnalytics <span class="keyword">from</span> <span class="string">'./components/ClientAnalytics'</span>

<span class="keyword">export default function</span> <span class="function">Page</span>() {
  <span class="keyword">const</span> nonce = headers().get(<span class="string">'x-nonce'</span>) || <span class="string">''</span>
  
  <span class="keyword">return</span> (
    &lt;main&gt;
      &lt;h1&gt;My Next.js App with CSP&lt;/h1&gt;
      
      <span class="comment">{/* Client Componentã«nonceã‚’æ¸¡ã™ */}</span>
      &lt;ClientAnalytics nonce={nonce} /&gt;
    &lt;/main&gt;
  )
}</code></pre>

            <h2>ğŸ® ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒ¢</h2>
            
            <div class="demo-container">
                <div class="demo-title">CSP Level 3ã®å‹•ä½œç¢ºèªãƒ‡ãƒ¢</div>
                
                <p>ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€nonceã‚ã‚Šã¨ãªã—ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼š</p>
                
                <button onclick="runWithNonce()">nonceã‚ã‚Šã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ</button>
                <button onclick="runWithoutNonce()">nonceãªã—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ</button>
                <button onclick="clearConsole()">ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ã‚¯ãƒªã‚¢</button>
                
                <div class="console-output" id="demoConsole">
                    <div class="console-line console-info">// ãƒ‡ãƒ¢ã‚³ãƒ³ã‚½ãƒ¼ãƒ« - ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</div>
                </div>
            </div>

            <h2>âš¡ ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹</h2>

            <h3>1. é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã®åˆ†é›¢</h3>
            <pre><code><span class="keyword">const</span> isDev = process.env.NODE_ENV === <span class="string">'development'</span>

<span class="keyword">const</span> cspHeader = isDev 
  ? <span class="string">"default-src * 'unsafe-inline' 'unsafe-eval';"</span> <span class="comment">// é–‹ç™ºç’°å¢ƒã¯ç·©ã</span>
  : <span class="string">`script-src 'nonce-</span><span class="string">${nonce}</span><span class="string">' 'strict-dynamic';`</span> <span class="comment">// æœ¬ç•ªã¯å³æ ¼ã«</span></code></pre>

            <h3>2. nonceã®ContextåŒ–ï¼ˆå¤§è¦æ¨¡ã‚¢ãƒ—ãƒªå‘ã‘ï¼‰</h3>
            <pre><code><span class="comment">// app/contexts/NonceContext.tsx</span>
<span class="string">'use client'</span>

<span class="keyword">import</span> { createContext, useContext } <span class="keyword">from</span> <span class="string">'react'</span>

<span class="keyword">const</span> NonceContext = createContext&lt;<span class="keyword">string</span>&gt;(<span class="string">''</span>)

<span class="keyword">export const</span> NonceProvider = ({ 
  children, 
  nonce 
}: { 
  children: React.ReactNode
  nonce: <span class="keyword">string</span>
}) =&gt; (
  &lt;NonceContext.Provider value={nonce}&gt;
    {children}
  &lt;/NonceContext.Provider&gt;
)

<span class="keyword">export const</span> useNonce = () =&gt; useContext(NonceContext)</code></pre>

            <h2>ğŸš¨ ã‚ˆãã‚ã‚‹å•é¡Œã¨è§£æ±ºç­–</h2>
            
            <div class="warning-box">
                <h4>å•é¡Œ1: Next.jsã®å†…éƒ¨ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹</h4>
                <p><strong>è§£æ±ºç­–ï¼š</strong> <code>strict-dynamic</code>ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ã§ã€Next.jsãŒå‹•çš„ã«ç”Ÿæˆã™ã‚‹ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚è¨±å¯ã•ã‚Œã¾ã™ã€‚</p>
            </div>
            
            <div class="warning-box">
                <h4>å•é¡Œ2: ã‚µãƒ¼ãƒ‰ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒå‹•ä½œã—ãªã„</h4>
                <p><strong>è§£æ±ºç­–ï¼š</strong> Next.jsã®<code>Script</code>ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’ä½¿ç”¨ã—ã€nonceã‚’æ¸¡ã—ã¾ã™ã€‚</p>
                <pre><code>&lt;Script
  src=<span class="string">"https://example.com/script.js"</span>
  strategy=<span class="string">"lazyOnload"</span>
  nonce={nonce}
/&gt;</code></pre>
            </div>
            
            <div class="warning-box">
                <h4>å•é¡Œ3: ã‚¹ã‚¿ã‚¤ãƒ«ãŒãƒ–ãƒ­ãƒƒã‚¯ã•ã‚Œã‚‹</h4>
                <p><strong>è§£æ±ºç­–ï¼š</strong> <code>style-src</code>ã«ã‚‚nonceã‚’è¿½åŠ ã—ã¾ã™ã€‚</p>
                <pre><code>style-src <span class="string">'self'</span> <span class="string">'nonce-${nonce}'</span>;</code></pre>
            </div>

            <h2>ğŸ“Š ã¾ã¨ã‚</h2>
            
            <div class="success-box">
                <h4>å®Ÿè£…ã®ãƒã‚¤ãƒ³ãƒˆ</h4>
                <ol>
                    <li><strong>ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢</strong>ã§ãƒªã‚¯ã‚¨ã‚¹ãƒˆã”ã¨ã«æ–°ã—ã„nonceã‚’ç”Ÿæˆ</li>
                    <li><strong>ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼</strong>çµŒç”±ã§nonceã‚’ä¼é”</li>
                    <li><strong>Server Component</strong>ã§<code>headers()</code>ã‹ã‚‰nonceå–å¾—</li>
                    <li><strong>Client Component</strong>ã«ã¯Propsã§nonceä¼é”</li>
                    <li><strong>strict-dynamic</strong>ã§å‹•çš„ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚å®‰å…¨ã«å®Ÿè¡Œ</li>
                </ol>
            </div>

            <div class="info-box">
                <p>CSP Level 3ã®å®Ÿè£…ã«ã‚ˆã‚Šã€XSSæ”»æ’ƒã‚’åŠ¹æœçš„ã«é˜²ããªãŒã‚‰ã€Next.jsã®å‹•çš„ãªæ©Ÿèƒ½ï¼ˆã‚³ãƒ¼ãƒ‰åˆ†å‰²ã€å‹•çš„ã‚¤ãƒ³ãƒãƒ¼ãƒˆãªã©ï¼‰ã‚’ç¶­æŒã§ãã¾ã™ã€‚ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã¨é–‹ç™ºä½“é¨“ã®ãƒãƒ©ãƒ³ã‚¹ã‚’å–ã‚‹æœ€é©ãªæ–¹æ³•ã§ã™ã€‚</p>
            </div>

        </article>
    </div>

    <script>
        function showTab(tabId) {
            // ã™ã¹ã¦ã®ã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // é¸æŠã•ã‚ŒãŸã‚¿ãƒ–ã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
            event.target.classList.add('active');
            document.getElementById(tabId).classList.add('active');
        }
        
        function addConsoleLog(message, type = 'info') {
            const console = document.getElementById('demoConsole');
            const timestamp = new Date().toLocaleTimeString();
            const classMap = {
                'success': 'console-success',
                'error': 'console-error',
                'info': 'console-info'
            };
            
            console.innerHTML += `<div class="console-line ${classMap[type]}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }
        
        function runWithNonce() {
            addConsoleLog('// nonceã‚ã‚Šã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ', 'info');
            setTimeout(() => {
                addConsoleLog('âœ“ script nonce="r@nd0m$tr1ng" ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸ', 'success');
                addConsoleLog('console.log("This script has valid nonce!")', 'success');
            }, 500);
        }
        
        function runWithoutNonce() {
            addConsoleLog('// nonceãªã—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œ', 'info');
            setTimeout(() => {
                addConsoleLog('âœ— Refused to execute inline script because it violates CSP', 'error');
                addConsoleLog('Content-Security-Policy: script-src \'nonce-r@nd0m$tr1ng\' \'strict-dynamic\'', 'error');
            }, 500);
        }
        
        function clearConsole() {
            document.getElementById('demoConsole').innerHTML = '<div class="console-line console-info">// ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ãŒã‚¯ãƒªã‚¢ã•ã‚Œã¾ã—ãŸ</div>';
        }
    </script>
</body>
</html>